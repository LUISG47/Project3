<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meteorite Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        #map { height: 500px; margin-top: 20px; }
        #info { font-size: 18px; margin-top: 20px; }
    </style>
</head>
<body>
    <h2>Select a Country:</h2>
    <select id="countrySelect">
        <option value="">All Countries</option>
    </select>

    <h2>Select a City:</h2>
    <select id="citySelect">
        <option value="">All Cities</option>
    </select>

    <div id="info">
        <h3>Demographic Info</h3>
        <p id="details">Select a meteorite to see details.</p>
    </div>

    <div id="map"></div>

    <script>
        let map = L.map('map').setView([20, 0], 2);
        let meteoriteData = [];
        let markers = L.layerGroup().addTo(map);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        async function fetchMeteorites() {
            const response = await fetch("https://data.nasa.gov/resource/gh4g-9sfh.json");
            return await response.json();
        }

        async function populateFilters() {
            meteoriteData = await fetchMeteorites();
            let countries = new Set();
            let countrySelect = document.getElementById("countrySelect");

            meteoriteData.forEach(meteorite => {
                if (meteorite.reclat && meteorite.reclong) {
                    let country = getCountryFromCoords(meteorite.reclat, meteorite.reclong, meteorite.name);
                    if (country && country !== "Unknown") {
                        countries.add(country);
                    }
                }
            });

            countries.forEach(country => {
                let option = document.createElement("option");
                option.value = country;
                option.textContent = country;
                countrySelect.appendChild(option);
            });

            countrySelect.addEventListener("change", updateCities);
        }

        // More accurate country determination with meteorite data
        function getCountryFromCoords(lat, lon, name) {
            // Check if the meteorite is one of the specific ones to be assigned to Mexico
            const meteoritesToMove = [
                "El Paso del Aguila", "Santa Cruz", "Mazapil", "Nuevo Mercurio", 
                "Avilez", "Ceniceros", "Allende"
            ];
            if (meteoritesToMove.includes(name)) {
                return "Mexico"; // Move these specific meteorites to Mexico
            }

            // USA bounds (with more precision)
            if (lat > 24 && lat < 49 && lon > -125 && lon < -67) return "USA"; 
            // Mexico bounds (narrower for better precision)
            if (lat > 14 && lat < 33 && lon > -118 && lon < -85) return "Mexico"; 
            // Canada bounds (adjusted slightly for better boundary)
            if (lat > 45 && lat < 85 && lon > -140 && lon < -60) return "Canada"; 
            // India bounds (adjusted for better precision)
            if (lat > 25 && lat < 40 && lon > 70 && lon < 100) return "India"; 
            // Australia bounds (precised)
            if (lat > -40 && lat < -10 && lon > 140 && lon < 160) return "Australia"; 
            // Brazil bounds (refined)
            if (lat > -35 && lat < 5 && lon > -75 && lon < -34) return "Brazil"; 
            // Argentina bounds
            if (lat > -55 && lat < -22 && lon > -75 && lon < -55) return "Argentina"; 
            // Peru bounds (narrowed)
            if (lat > -18 && lat < 0 && lon > -81 && lon < -65) return "Peru"; 
            // Chile bounds (refined)
            if (lat > -56 && lat < -17 && lon > -75 && lon < -66) return "Chile"; 
            // Colombia bounds
            if (lat > 5 && lat < 15 && lon > -80 && lon < -65) return "Colombia"; 
            // Ecuador bounds
            if (lat > -5 && lat < 5 && lon > -80 && lon < -75) return "Ecuador"; 
            // Venezuela bounds
            if (lat > 0 && lat < 13 && lon > -73 && lon < -60) return "Venezuela"; 
            // Bolivia bounds
            if (lat > -22 && lat < -9 && lon > -70 && lon < -55) return "Bolivia"; 
            // Uruguay bounds
            if (lat > -35 && lat < -30 && lon > -58 && lon < -53) return "Uruguay"; 
            // Paraguay bounds
            if (lat > -28 && lat < -19 && lon > -60 && lon < -55) return "Paraguay"; 
            // Europe bounds (narrower)
            if (lat > 35 && lat < 60 && lon > -10 && lon < 40) return "Europe"; 

            return "Unknown"; // If no match
        }

        function updateCities() {
            let selectedCountry = document.getElementById("countrySelect").value;
            let cities = new Set();
            let citySelect = document.getElementById("citySelect");

            citySelect.innerHTML = `<option value="">All Cities</option>`;

            meteoriteData.forEach(meteorite => {
                let country = getCountryFromCoords(meteorite.reclat, meteorite.reclong, meteorite.name);
                if (country === selectedCountry) {
                    cities.add(meteorite.name);
                }
            });

            cities.forEach(city => {
                let option = document.createElement("option");
                option.value = city;
                option.textContent = city;
                citySelect.appendChild(option);
            });

            citySelect.addEventListener("change", updateMap);
            updateMap();
        }

        function updateMap() {
            markers.clearLayers();
            let selectedCountry = document.getElementById("countrySelect").value;
            let selectedCity = document.getElementById("citySelect").value;

            meteoriteData.forEach(meteorite => {
                let country = getCountryFromCoords(meteorite.reclat, meteorite.reclong, meteorite.name);
                if ((selectedCountry === "" || country === selectedCountry) && 
                    (selectedCity === "" || meteorite.name === selectedCity)) {
                    
                    let lat = parseFloat(meteorite.reclat);
                    let lon = parseFloat(meteorite.reclong);
                    let details = `<strong>${meteorite.name}</strong><br>Mass: ${meteorite.mass || "Unknown"} g`;

                    L.marker([lat, lon])
                        .bindPopup(details)
                        .addTo(markers);
                }
            });
        }

        populateFilters();
    </script>
</body>
</html>
